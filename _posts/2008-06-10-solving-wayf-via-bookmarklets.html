---
layout: post
title: Solving WAYF via Bookmarklets
date: '2008-06-10T22:54:00.009-05:00'
author: rammic
tags:
- SAML
- bookmarklet
- wayf
- infocard
- federation
modified_time: '2008-06-12T08:22:35.744-05:00'
blogger_id: tag:blogger.com,1999:blog-6180833599810788176.post-3843775070479169162
blogger_orig_url: http://blog.rammic.com/2008/06/solving-wayf-via-bookmarklets.html
---

<span class="Apple-style-span"  style="font-size:small;">The power of bookmarklets is still to be seen in many situations. Consider the "Where Are You From?" (WAYF) problem, a common issue with federation technologies. The simple question of where to send the user to complete a federated authentication is one of the more complicated and error prone issues in identity federation. The key metrics for any WAYF solution are that the user should have the opportunity to choose any relevant identity context and the process should be hard for a RP to subvert. </span><div><span class="Apple-style-span"  style="font-size:small;"><br /></span><div><span class="Apple-style-span"  style="font-size:small;">-SAML 1 tokens can be retrieved from an IDP with a specially formed HTTP GET request and a TARGET parameter pointing back to the RP site, though a pre-existing relationship must exist in order to allow this to work since most of the request (attributes, authN) is implicit and expressed in the SAML metadata. </span></div><div><span class="Apple-style-span"  style="font-size:small;"><br /></span></div><div><span class="Apple-style-span"  style="font-size:small;">-SAML2 tokens can be retrieved from an IDP with a HTTP POST request which articulates the request parameters (attributes, authN), but still requires the RP to be explicitly aware of supported IDP(s). While there are some tricks in the specification regarding the use of domain cookies, the approach is not very dynamic and is still prone to spoofing and other problems.</span></div><div><span class="Apple-style-span"  style="font-size:small;"><br /></span></div><div><span class="Apple-style-span"  style="font-size:small;">-InfoCard solves the problem through the user's selection of a card. The card is indicative of the location of the target identity provider. This is the best approach thus far, though it lacks ubiquity at the moment.</span></div><div><span class="Apple-style-span"  style="font-size:small;"><br /></span></div><div><span class="Apple-style-span"  style="font-size:small;">-OpenID addresses the problem by the user being prompted to input their OpenID url. This is the most straightforward approach, as the user is compelled to identify the IDP explicitly (or at least a pointer). Aside from a steeper learning curve, this approach suffers from spoofability assuming a malicious RP (as does SAML).</span></div><div><span class="Apple-style-span"  style="font-size:small;"><br /></span></div><div><span class="Apple-style-span"  style="font-size:small;">While all address the problem with varying levels of success, I believe that the bookmarklet approach maintains the benefits of wide interoperability while reducing spoofability of the IDP's interface. The provisioning process would work like so:</span></div><div><ol><li><span class="Apple-style-span"  style="font-size:small;">The user logs into the IDP for the first time.</span></li><li><span class="Apple-style-span"  style="font-size:small;">The IDP validates user's credentials, offers bookmarklet which can be stored in the user's browser. The bookmarklet has sufficient logic to parse the protocol specific parameters from the RP site required to issue a token.</span></li><li><span class="Apple-style-span"  style="font-size:small;">The user accesses an RP site and navigates to the login page. </span></li><li><span class="Apple-style-span"  style="font-size:small;">The user clicks the IDP's bookmarklet. The bookmarklet's Javascript parses the RP's information and redirects the browser to the IDP's site with the RP's parameters encoded into the URL.</span></li></ol><div><span class="Apple-style-span"  style="font-size:small;">This approach works with all modern browsers. (except IE7, though IE8 works!) It preserves the user centricity of the interaction because the user has to choose an identity bookmarklet to log in, and it reduces spoofability since we are not depending on the RP to preform the redirection. This profile is sufficiently abstract enough that it could be used to improve existing SAML enterprises and could easily be integrated to OpenID.</span></div><div><span class="Apple-style-span"  style="font-size:small;"><br /></span></div><div><span class="Apple-style-span"  style="font-size:small;">The bookmarklet code itself is extremely simple. If we use Infocard as our example, we can easily search for the embedded object type of "applicationx/infocard," gather the required/optional claims, and redirect the user's browser to the IDP's site. Assuming the browser supports the "infocard://" protocol:</span></div><div><span class="Apple-style-span"  style="font-family:'times new roman';"><br /></span></div><div><span class="Apple-style-span"  style="font-family:'times new roman';"><p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"></p><p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"></p><p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span class="Apple-style-span" style="color: rgb(142, 0, 255); "><span style="color:#7f0055;">var </span><span style="color:#000000;">idp=</span>"infocard://"<span style="color:#000000;">;</span></span></p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;">var </span>objects = document.getElementsByTagName(<span style="color:#8e00ff;">"object"</span>);</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;">var </span>infocardObject;</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;">for</span>(<span style="color:#7f0055;">var </span>i = 0; i &lt; objects.length &amp;&amp; infocardObject == null; i++){</p> <p  style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color:#8e00ff;"><span style="color:#7f0055;"><span class="Apple-tab-span" style="white-space:pre"> </span>if</span><span style="color:#000000;">(objects[i].type == </span>"application/x-informationCard"<span style="color:#000000;">)</span></p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span class="Apple-tab-span" style="white-space:pre">  </span>infocardObject = objects[i];</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;">}</span></p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;">if</span>(infocardObject == <span style="color:#7f0055;">null</span>)<span style="color:#7f0055;">{<span class="Apple-style-span" style="color: rgb(142, 0, 255); "><span style="color:#7f0055;"><span class="Apple-tab-span" style="white-space:pre"></span></span></span></span></p><p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;"><span class="Apple-style-span" style="color: rgb(142, 0, 255); "><span style="color:#7f0055;"><span class="Apple-tab-span" style="white-space:pre"> </span></span><span style="color:#000000;">alert(</span>"It appears there is no InfoCard login on this page."<span style="color:#000000;">);</span></span></span></p> <p  style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color:#7f0055;">}else{</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;"><span class="Apple-tab-span" style="white-space:pre"> </span>var </span>parentElement = infocardObject;</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span class="Apple-tab-span" style="white-space:pre"> </span><span style="color:#7f0055;">while</span>(parentElement != <span style="color:#7f0055;">null </span>&amp;&amp; !parentElement.action)</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span class="Apple-tab-span" style="white-space:pre">  </span>parentElement = parentElement.parentNode;</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span class="Apple-tab-span" style="white-space:pre"> </span><span style="color:#7f0055;">var </span>target = parentElement == <span style="color:#7f0055;">null </span>? window.location.pathname: parentElement.action;</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span class="Apple-tab-span" style="white-space:pre"> </span><span style="color:#7f0055;">var </span>requiredClaims=(document.getElementsByName(<span style="color:#8e00ff;">"requiredClaims"</span>)[0].value).replace(/\s+/g,<span style="color:#8e00ff;">'%20'</span>);</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span class="Apple-tab-span" style="white-space:pre"> </span>document.location.href=idp+<span style="color:#8e00ff;">"requiredClaims="</span>+requiredClaims+<span style="color:#8e00ff;">"&amp;paramName="</span>+infocardObject.name+<span style="color:#8e00ff;">"&amp;respondToUrl="</span>+target;</p> <p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco"><span style="color:#7f0055;">}</span></p> <p color="#7f0055" style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; "><span class="Apple-style-span"  style="font-size:small;"><br /></span></p><p></p><p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color:#7f0055;"><span class="Apple-style-span" style="color: rgb(0, 0, 0);   "><span class="Apple-style-span"  style="font-family:georgia;"><span class="Apple-style-span"  style="font-size:small;">If the browser isn't cooperative, then we can replace the idp variable with the hard-coded URL for the IDP, though the user is then forced to have multiple bookmarklets. </span></span></span></p><p></p><p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #7f0055"></p></span></div></div></div>