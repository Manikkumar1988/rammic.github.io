---
layout: post
title: Viscosity, OpenVPN and DNS Priority
date: '2009-04-09T14:53:00.006-05:00'
author: rammic
tags:
- vpn
- osx
modified_time: '2009-04-13T12:07:32.239-05:00'
blogger_id: tag:blogger.com,1999:blog-6180833599810788176.post-2694452597264917083
blogger_orig_url: http://blog.rammic.com/2009/04/viscosity-openvpn-and-dns-priority.html
---

I wanted to change my DNS settings when connecting to an OpenVPN server using <a href="http://www.viscosityvpn.com/">Viscosity</a>. Using the <span class="Apple-style-span"  style="font-family:'courier new';">resolv.conf</span> and other methods didn't seem to have any effect, so I put together a solution that seems to work.<div><br /></div><div>First, put these <a href="http://developer.apple.com/DOCUMENTATION/DARWIN/Reference/ManPages/man8/scutil.8.html">scutil</a> commands into a file (we'll call it <span class="Apple-style-span"  style="font-family:'courier new';">/usr/local/bin/changeDns.pref</span>):</div><div><div><blockquote><div><span class="Apple-style-span"  style="font-family:'courier new';">get State:/Network/Service/0/DNS</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">d.add ServerAddresses * 192.168.1.1 10.0.0.1</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">set State:/Network/Service/0/DNS</span></div><div></div></blockquote></div><div>Notice that the <span class="Apple-style-span"  style="font-family:'courier new';">ServerAddresses</span> line has my DNS servers in order of priority. Change this to match your desired DNS resolution configuration. This settings will be automatically undone once the connection has been severed.</div><div><br /></div><div><i>(Edit: The </i><span class="Apple-style-span"  style="font-family:'courier new';"><i>/Network/Service/0/DNS</i></span><i> line is from my configuration, but it apparently varies between computers. You may need to run the scutil command </i><span class="Apple-style-span" style="white-space: pre; "><span class="Apple-style-span"  style="font-family:'courier new';"><span class="Apple-style-span" style="font-size: medium;"><i>list State:/Network/Service/[^/]+/DNS</i></span></span></span><i> to find the name of your DNS service. Citation </i><a href="http://www.afp548.com/article.php?story=20050703052052393"><i>here</i></a><i>.)</i></div><div><br /></div><div>Now, we need to edit the <span class="Apple-style-span"  style="font-family:'courier new';">/Applications/Viscosity.app/Contents/Resources/dnsupalt.py </span>file (the script which is run when Viscosity connects). Put this after the nameservers and search_domains line:</div><div><div><blockquote><div><span class="Apple-style-span"  style="font-family:'courier new';">#!/usr/bin/env python</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';"># Viscosity DNS Support Script                                                  </span></div><div><span class="Apple-style-span"  style="font-family:'courier new';"># http://www.viscosityvpn.com</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">import os, re, sys</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';"><br /></span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">nameservers = []</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">search_domains = []</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';"><br /></span></div><div><span class="Apple-style-span"  style="font-family:'courier new';"><b>os.system("scutil < </b></span><span class="Apple-style-span"  style="font-family:'courier new';"><b>/usr/local/bin/changeDns.pref</b></span><span class="Apple-style-span"  style="font-family:'courier new';"><b>")</b></span></div><div></div></blockquote></div><div>This tells <span class="Apple-style-span"  style="font-family:'courier new';">scutil</span> to run the file upon connection.  Running <span class="Apple-style-span"  style="font-family:'courier new';">scutil --dns</span> after connecting shows that the DNS servers have been updated:</div><div><div><span class="Apple-style-span"  style="font-family:'courier new';"><blockquote><div><span class="Apple-style-span"  style="font-family:'courier new';">resolver #1</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">  nameserver[0] : 192.168.1.1</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">  nameserver[1] : 10.0.0.1</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">  order   : 200000</span></div></blockquote></span></div><div><span class="Apple-style-span"  style="font-family:'courier new';"></span></div><div>Disconnect and the system goes back to the DNS server offered by DHCP:</div><div><div><span class="Apple-style-span"  style="font-family:'courier new';"><blockquote><div><span class="Apple-style-span"  style="font-family:'courier new';">resolver #1</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">  nameserver[0] : 10.0.0.1</span></div><div><span class="Apple-style-span"  style="font-family:'courier new';">  order   : 200000</span></div></blockquote></span></div><div><span class="Apple-style-span"  style="font-family:'courier new';"></span></div><div><br /></div></div></div></div></div>